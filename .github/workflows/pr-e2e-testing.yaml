name: "E2E testing (Parallel Build)"

on:
  workflow_call:
    inputs:
      tag:
        description: "Image tag"
        required: true
        type: string
      e2e_matrix:
        description: "E2E matrix JSON array string"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: read

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  QUAY_ORG: quay.io/flightctl
  QUAY_TESTS_ORG: quay.io/flightctl-tests
  REGISTRY: quay.io
  REGISTRY_OWNER: flightctl
  REGISTRY_OWNER_TESTS: flightctl-tests
  GITHUB_ACTIONS: true

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      e2e_matrix: ${{ steps.prepare.outputs.e2e_matrix }}
      label_matrix: ${{ steps.prepare.outputs.label_matrix }}
      rpm_matrix: ${{ steps.prepare.outputs.rpm_matrix }}
      agent_matrix: ${{ steps.prepare.outputs.agent_matrix }}
    steps:
      - name: Prepare derived matrices
        id: prepare
        env:
          E2E_MATRIX: ${{ inputs.e2e_matrix }}
        run: |
          set -euo pipefail

          echo "$E2E_MATRIX" | jq -e 'type == "array"' >/dev/null
          echo "$E2E_MATRIX" | jq -e '
            all(.[]; type == "object")
            and all(.[]; (.os_id | type == "string" and length > 0))
            and all(.[]; (.backend_type | type == "string" and length > 0))
            and all(.[]; (.label_filter | type == "string" and length > 0))
            and all(.[]; (.ginkgo_total_nodes | (type == "number" or type == "integer")))
          ' >/dev/null

          e2e_matrix=$(echo "$E2E_MATRIX" | jq -c '{include: [.[] | {os_id, backend_type, label_filter, ginkgo_total_nodes}]}')
          label_matrix=$(echo "$E2E_MATRIX" | jq -c '{include: ([.[].label_filter] | unique | map({label_filter: .}))}')

          agent_matrix=$(echo "$E2E_MATRIX" | jq -c '
            def rpm_suffix:
              if . == "cs9-bootc" then "centos-stream+epel-next-9-x86_64"
              elif . == "cs10-bootc" then "epel-10-x86_64"
              else error("unknown os_id: " + .)
              end;
            {include: ([.[].os_id] | unique | map({os_id: ., rpm_suffix: (.|rpm_suffix)}))}
          ')

          rpm_matrix=$(echo "$agent_matrix" | jq -c '{include: ([.include[].rpm_suffix] | unique | map({root: .}))}')

          {
            echo "e2e_matrix=$e2e_matrix"
            echo "label_matrix=$label_matrix"
            echo "agent_matrix=$agent_matrix"
            echo "rpm_matrix=$rpm_matrix"
          } >> "$GITHUB_OUTPUT"

  build-images-and-charts:
    uses: ./.github/workflows/build-images-and-charts.yaml

  build-flightctl-cli:
    needs: [build-images-and-charts]
    runs-on: ubuntu-24.04
    outputs:
      tag: ${{ inputs.tag }}
    steps:
      - name: CLI built with backend job
        run: echo "CLI artifact produced by build-images-and-charts"

  build-rpms:
    needs: prepare-matrix
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.rpm_matrix) }}
    uses: ./.github/workflows/build-rpms.yaml
    with:
      root: ${{ matrix.root }}

  build-agent-images-unified:
    needs: [prepare-matrix, build-rpms]
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.agent_matrix) }}
    uses: ./.github/workflows/build-agent-images.yaml
    with:
      rpm_suffix: ${{ matrix.rpm_suffix }}
      os_id: ${{ matrix.os_id }}
      tag: ${{ inputs.tag }}

  discover-e2e-tests:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.label_matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup dependencies
        uses: ./.github/actions/setup-dependencies

      - name: Compute label filter hash
        id: compute-hash
        run: |
          HASH=$(printf '%s' "${{ matrix.label_filter }}" | sha256sum | cut -c1-8)
          echo "hash=${HASH}" >> "$GITHUB_OUTPUT"
          echo "Label filter: ${{ matrix.label_filter }}"
          echo "Hash: ${HASH}"

      - name: Run test discovery
        env:
          GINKGO_LABEL_FILTER: ${{ matrix.label_filter }}
          DISCOVERY_ONLY: "true"
          DISCOVERY_PATH: discovery.json
        run: |
          mkdir -p reports
          test/scripts/run_e2e_tests.sh reports ./test/e2e/...

      - name: Validate discovery results
        run: |
          echo "=== Discovery file info ==="
          ls -la discovery.json

          echo ""
          echo "=== Discovery content (formatted) ==="
          jq '.' discovery.json

          echo ""
          echo "=== Tests found ==="
          TEST_COUNT=$(jq -r '[.[] | .SpecReports[]? | select(.LeafNodeLabels != null)] | length' discovery.json)
          echo "Total tests found with filter '${{ matrix.label_filter }}': ${TEST_COUNT}"

          if [[ "${TEST_COUNT}" -eq 0 ]]; then
            echo "ERROR: No tests found in discovery! Check for compilation errors above."
            exit 1
          fi

      - name: Upload discovery artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-discovery-${{ steps.compute-hash.outputs.hash }}-${{ inputs.tag }}
          path: discovery.json
          retention-days: 1

  e2e-tests:
    needs:
      - build-images-and-charts
      - build-flightctl-cli
      - build-agent-images-unified
      - discover-e2e-tests
      - prepare-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.e2e_matrix) }}
    uses: ./.github/workflows/run-e2e-tests.yaml
    with:
      os_id: ${{ matrix.os_id }}
      backend_type: ${{ matrix.backend_type }}
      ginkgo_total_nodes: ${{ matrix.ginkgo_total_nodes }}
      ginkgo_label_filter: ${{ matrix.label_filter }}
      tag: ${{ inputs.tag }}

  e2e:
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    steps:
      - name: Check E2E Test Results
        run: |
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "All E2E tests passed!"
            exit 0
          elif [[ "${{ needs.e2e-tests.result }}" == "skipped" ]]; then
            echo "E2E tests were skipped (docs-only changes)"
            exit 0
          else
            echo "E2E tests failed or were cancelled"
            exit 1
          fi
