<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation for FlightCtl - Fleet management for edge devices"><link href=https://flightctl.github.io/flightctl/user/building-images/ rel=canonical><link href=../provisioning-devices/ rel=prev><link href=../configuring-agent/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.15"><title>Building Images - FlightCtl Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#building-os-images class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="FlightCtl Documentation" class="md-header__button md-logo" aria-label="FlightCtl Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> FlightCtl Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Building Images </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/flightctl/flightctl title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> flightctl/flightctl </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../developer/ class=md-tabs__link> Developer Guide </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="FlightCtl Documentation" class="md-nav__button md-logo" aria-label="FlightCtl Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> FlightCtl Documentation </label> <div class=md-nav__source> <a href=https://github.com/flightctl/flightctl title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> flightctl/flightctl </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> User Guide </span> </a> <label class="md-nav__link " for=__nav_2 id=__nav_2_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../install-cli/ class=md-nav__link> <span class=md-ellipsis> Install CLI </span> </a> </li> <li class=md-nav__item> <a href=../managing-devices/ class=md-nav__link> <span class=md-ellipsis> Managing Devices </span> </a> </li> <li class=md-nav__item> <a href=../managing-fleets/ class=md-nav__link> <span class=md-ellipsis> Managing Fleets </span> </a> </li> <li class=md-nav__item> <a href=../provisioning-devices/ class=md-nav__link> <span class=md-ellipsis> Provisioning Devices </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Building Images </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Building Images </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-os-images-and-the-image-build-process class=md-nav__link> <span class=md-ellipsis> Understanding OS Images and the Image Build Process </span> </a> </li> <li class=md-nav__item> <a href=#building-and-publishing-os-images-and-disk-images class=md-nav__link> <span class=md-ellipsis> Building and Publishing OS Images and Disk Images </span> </a> <nav class=md-nav aria-label="Building and Publishing OS Images and Disk Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#choosing-an-enrollment-method class=md-nav__link> <span class=md-ellipsis> Choosing an Enrollment Method </span> </a> </li> <li class=md-nav__item> <a href=#requesting-an-enrollment-certificate class=md-nav__link> <span class=md-ellipsis> Requesting an Enrollment Certificate </span> </a> </li> <li class=md-nav__item> <a href=#building-the-os-image-bootc class=md-nav__link> <span class=md-ellipsis> Building the OS Image (bootc) </span> </a> <nav class=md-nav aria-label="Building the OS Image (bootc)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-rhel-base-images class=md-nav__link> <span class=md-ellipsis> Using RHEL base images </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signing-and-publishing-the-os-image-bootc class=md-nav__link> <span class=md-ellipsis> Signing and Publishing the OS Image (bootc) </span> </a> </li> <li class=md-nav__item> <a href=#building-the-os-disk-image class=md-nav__link> <span class=md-ellipsis> Building the OS Disk Image </span> </a> </li> <li class=md-nav__item> <a href=#optional-signing-and-publishing-the-os-disk-image-to-an-oci-registry class=md-nav__link> <span class=md-ellipsis> Optional: Signing and Publishing the OS Disk Image to an OCI Registry </span> </a> </li> <li class=md-nav__item> <a href=#further-references class=md-nav__link> <span class=md-ellipsis> Further References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations-for-specific-target-platforms class=md-nav__link> <span class=md-ellipsis> Considerations for Specific Target Platforms </span> </a> <nav class=md-nav aria-label="Considerations for Specific Target Platforms"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#red-hat-openshift-virtualization class=md-nav__link> <span class=md-ellipsis> Red Hat OpenShift Virtualization </span> </a> </li> <li class=md-nav__item> <a href=#vmware-vsphere class=md-nav__link> <span class=md-ellipsis> VMware vSphere </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#best-practices-when-building-images class=md-nav__link> <span class=md-ellipsis> Best Practices When Building Images </span> </a> <nav class=md-nav aria-label="Best Practices When Building Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prefer-build-time-configuration-over-dynamic-runtime-configuration class=md-nav__link> <span class=md-ellipsis> Prefer Build-time Configuration over Dynamic Runtime Configuration </span> </a> </li> <li class=md-nav__item> <a href=#prefer-configuration-in-usr-over-etc class=md-nav__link> <span class=md-ellipsis> Prefer Configuration in /usr over /etc </span> </a> </li> <li class=md-nav__item> <a href=#use-drop-in-directories class=md-nav__link> <span class=md-ellipsis> Use Drop-in Directories </span> </a> </li> <li class=md-nav__item> <a href=#avoid-mutating-the-file-system-out-of-band class=md-nav__link> <span class=md-ellipsis> Avoid Mutating the File System Out-of-Band </span> </a> </li> <li class=md-nav__item> <a href=#further-references_1 class=md-nav__link> <span class=md-ellipsis> Further References </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../configuring-agent/ class=md-nav__link> <span class=md-ellipsis> Configuring Agent </span> </a> </li> <li class=md-nav__item> <a href=../api-resources/ class=md-nav__link> <span class=md-ellipsis> API Resources </span> </a> </li> <li class=md-nav__item> <a href=../auth-resources/ class=md-nav__link> <span class=md-ellipsis> Auth Resources </span> </a> </li> <li class=md-nav__item> <a href=../device-api-statuses/ class=md-nav__link> <span class=md-ellipsis> Device API Statuses </span> </a> </li> <li class=md-nav__item> <a href=../field-selectors/ class=md-nav__link> <span class=md-ellipsis> Field Selectors </span> </a> </li> <li class=md-nav__item> <a href=../kubernetes-auth/ class=md-nav__link> <span class=md-ellipsis> Kubernetes Auth </span> </a> </li> <li class=md-nav__item> <a href=../registering-microshift-devices-acm/ class=md-nav__link> <span class=md-ellipsis> Registering MicroShift Devices ACM </span> </a> </li> <li class=md-nav__item> <a href=../disconnected-cluster/ class=md-nav__link> <span class=md-ellipsis> Disconnected Cluster </span> </a> </li> <li class=md-nav__item> <a href=../alerts/ class=md-nav__link> <span class=md-ellipsis> Alerts </span> </a> </li> <li class=md-nav__item> <a href=../security-guidelines/ class=md-nav__link> <span class=md-ellipsis> Security Guidelines </span> </a> </li> <li class=md-nav__item> <a href=../network-requirements/ class=md-nav__link> <span class=md-ellipsis> Network Requirements </span> </a> </li> <li class=md-nav__item> <a href=../database-migration/ class=md-nav__link> <span class=md-ellipsis> Database Migration </span> </a> </li> <li class=md-nav__item> <a href=../service-observability/ class=md-nav__link> <span class=md-ellipsis> Service Observability </span> </a> </li> <li class=md-nav__item> <a href=../standalone-observability/ class=md-nav__link> <span class=md-ellipsis> Standalone Observability </span> </a> </li> <li class=md-nav__item> <a href=../troubleshooting/ class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../developer/ class=md-nav__link> <span class=md-ellipsis> Developer Guide </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#understanding-os-images-and-the-image-build-process class=md-nav__link> <span class=md-ellipsis> Understanding OS Images and the Image Build Process </span> </a> </li> <li class=md-nav__item> <a href=#building-and-publishing-os-images-and-disk-images class=md-nav__link> <span class=md-ellipsis> Building and Publishing OS Images and Disk Images </span> </a> <nav class=md-nav aria-label="Building and Publishing OS Images and Disk Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#choosing-an-enrollment-method class=md-nav__link> <span class=md-ellipsis> Choosing an Enrollment Method </span> </a> </li> <li class=md-nav__item> <a href=#requesting-an-enrollment-certificate class=md-nav__link> <span class=md-ellipsis> Requesting an Enrollment Certificate </span> </a> </li> <li class=md-nav__item> <a href=#building-the-os-image-bootc class=md-nav__link> <span class=md-ellipsis> Building the OS Image (bootc) </span> </a> <nav class=md-nav aria-label="Building the OS Image (bootc)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#using-rhel-base-images class=md-nav__link> <span class=md-ellipsis> Using RHEL base images </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#signing-and-publishing-the-os-image-bootc class=md-nav__link> <span class=md-ellipsis> Signing and Publishing the OS Image (bootc) </span> </a> </li> <li class=md-nav__item> <a href=#building-the-os-disk-image class=md-nav__link> <span class=md-ellipsis> Building the OS Disk Image </span> </a> </li> <li class=md-nav__item> <a href=#optional-signing-and-publishing-the-os-disk-image-to-an-oci-registry class=md-nav__link> <span class=md-ellipsis> Optional: Signing and Publishing the OS Disk Image to an OCI Registry </span> </a> </li> <li class=md-nav__item> <a href=#further-references class=md-nav__link> <span class=md-ellipsis> Further References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#considerations-for-specific-target-platforms class=md-nav__link> <span class=md-ellipsis> Considerations for Specific Target Platforms </span> </a> <nav class=md-nav aria-label="Considerations for Specific Target Platforms"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#red-hat-openshift-virtualization class=md-nav__link> <span class=md-ellipsis> Red Hat OpenShift Virtualization </span> </a> </li> <li class=md-nav__item> <a href=#vmware-vsphere class=md-nav__link> <span class=md-ellipsis> VMware vSphere </span> </a> </li> <li class=md-nav__item> <a href=#references class=md-nav__link> <span class=md-ellipsis> References </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#best-practices-when-building-images class=md-nav__link> <span class=md-ellipsis> Best Practices When Building Images </span> </a> <nav class=md-nav aria-label="Best Practices When Building Images"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#prefer-build-time-configuration-over-dynamic-runtime-configuration class=md-nav__link> <span class=md-ellipsis> Prefer Build-time Configuration over Dynamic Runtime Configuration </span> </a> </li> <li class=md-nav__item> <a href=#prefer-configuration-in-usr-over-etc class=md-nav__link> <span class=md-ellipsis> Prefer Configuration in /usr over /etc </span> </a> </li> <li class=md-nav__item> <a href=#use-drop-in-directories class=md-nav__link> <span class=md-ellipsis> Use Drop-in Directories </span> </a> </li> <li class=md-nav__item> <a href=#avoid-mutating-the-file-system-out-of-band class=md-nav__link> <span class=md-ellipsis> Avoid Mutating the File System Out-of-Band </span> </a> </li> <li class=md-nav__item> <a href=#further-references_1 class=md-nav__link> <span class=md-ellipsis> Further References </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/flightctl/flightctl/edit/master/docs/user/building-images.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg> </a> <a href=https://github.com/flightctl/flightctl/raw/master/docs/user/building-images.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg> </a> <h1 id=building-os-images>Building OS Images<a class=headerlink href=#building-os-images title="Permanent link">&para;</a></h1> <h2 id=understanding-os-images-and-the-image-build-process>Understanding OS Images and the Image Build Process<a class=headerlink href=#understanding-os-images-and-the-image-build-process title="Permanent link">&para;</a></h2> <p>Image-based OSes allow the whole OS (and optionally also OS configuration and applications) to be versioned, deployed, and updated as a single unit. This reduces operational risk:</p> <ul> <li>It minimizes potential drift between what has been thoroughly tested and what is deployed to a large number of devices.</li> <li>It minimizes the risk of failed updates that require expensive maintenance or replacement through transactional updates and rollbacks.</li> </ul> <p>Flight Control initially focuses on image-based Linux OSes running <a href=https://containers.github.io/bootc/ >bootable container images (bootc)</a>, with support for <a href=https://ostreedev.github.io/ostree/ >ostree</a> and <a href=https://coreos.github.io/rpm-ostree/ >rpm-ostree</a> images planned for later. It does not update package-based OSes.</p> <p>At a high level, the image building process for bootc works as follows:</p> <ol> <li>Choose a base bootc image (for example Fedora, CentOS, or RHEL).</li> <li>Create a Containerfile that layers onto that base image<ul> <li>the Flight Control agent and configuration,</li> <li>(optionally) any drivers specific to your target deployment environment, and</li> <li>(optionally) host configuration (e.g. CA bundles) and application workloads common to all deployments from this image.</li> </ul> </li> <li>Build, publish, and sign an <strong>OS image (bootc)</strong> using <code>podman</code> and <code>skopeo</code>.</li> <li>Build, publish, and sign an <strong>OS disk image</strong> using <code>bootc-image-builder</code> (bib) and <code>skopeo</code>.</li> </ol> <p><picture> <source media="(prefers-color-scheme: light)" srcset=https://raw.githubusercontent.com/flightctl/flightctl/main/docs/images/image-building.svg> <source media="(prefers-color-scheme: dark)" srcset=https://raw.githubusercontent.com/flightctl/flightctl/main/docs/images/image-building-dark.svg> <img alt="Diagram of image building process" src=https://raw.githubusercontent.com/flightctl/flightctl/main/docs/images/image-building.svg> </picture></p> <p>The OS disk image is used to image (or "flash") a device when it is provisioned. For subsequent device updates, only the OS image (bootc) is required. This is because bootc is a <em>file system</em> image, that is it contains just the files in the file system including their attributes, but the disk layout (partitions, volumes) and file systems need to have been created first. The OS disk image includes everything, the disk layout, bootloader, file systems, and the files in the OS image (bootc). It can therefore be written verbatim to the device's drive.</p> <h2 id=building-and-publishing-os-images-and-disk-images>Building and Publishing OS Images and Disk Images<a class=headerlink href=#building-and-publishing-os-images-and-disk-images title="Permanent link">&para;</a></h2> <p>This section describes the generic process for building an OS image (bootc) that contains the Flight Control agent and building an OS disk image for flashing to physical devices. Later sections then describe considerations when building for specific virtualization and bare metal provisioning environments.</p> <p>Before you start, ensure you have installed the following prerequisites:</p> <ul> <li><code>flightctl</code> CLI latest version (<a href=../getting-started/#installing-the-flight-control-cli>installation guide</a>)</li> <li><code>podman</code> version 5.0 or higher (<a href=https://podman.io/docs/installation>installation guide</a>)</li> <li><code>skopeo</code> version 1.14 or higher (<a href=https://github.com/containers/skopeo/blob/main/install.md>installation guide</a>)</li> </ul> <h3 id=choosing-an-enrollment-method>Choosing an Enrollment Method<a class=headerlink href=#choosing-an-enrollment-method title="Permanent link">&para;</a></h3> <p>When the Flight Control agent starts, it expects to find its configuration in <code>/etc/flightctl/config.yaml</code>. This configuration needs to contain:</p> <ul> <li>the Flight Control enrollment service to connect to (enrollment endpoint),</li> <li>the X.509 client certificate and key to connect with (enrollment certificate),</li> <li>optionally, any further agent configuration (see <a href=../configuring-agent/ >Configuring the Flight Control Agent</a>).</li> </ul> <p>You can provision the enrollment endpoint and certificate to the device in the following ways:</p> <ul> <li><strong>Early binding:</strong> You can build an OS image that includes both the enrollment endpoint and certificate.</li> </ul> <p>Devices using this image can automatically connect to "their" Flight Control service to request enrollment, without depending on any provisioning infrastructure. On the other hand, devices are bound to a specific service and owner. They also share the same, typically long-lived X.509 client certificate for connecting to the enrollment service.</p> <ul> <li><strong>Late binding:</strong> You can build an OS image without enrollment endpoint and certificate and instead inject both at provisioning-time.</li> </ul> <p>Devices using this image are not bound to a single owner or service and can have device-specific, short-lived X.509 client certificates for connecting to the enrollment service. However, late binding requires virtualization or bare metal provisioning infrastructure that can request device-specific enrollment endpoints and certificates from Flight Control and inject them into the provisioned device using mechanisms such as <a href=https://cloud-init.io/ >cloud-init</a>, <a href=https://coreos.github.io/ignition/supported-platforms/ >Ignition</a>, or <a href=https://anaconda-installer.readthedocs.io/en/latest/kickstart.html>kickstart</a>.</p> <blockquote> <p>[!NOTE] The enrollment certificate is only used to secure the network connection for submitting an enrollment request. It is not involved in the actual verification or approval of the enrollment request. It is also no longer used with enrolled devices, as these rely on device-specific management certificates instead.</p> </blockquote> <p>The following procedure describes the early binding method of building the agent configuration including the enrollment endpoint and certificate into the image.</p> <h3 id=requesting-an-enrollment-certificate>Requesting an Enrollment Certificate<a class=headerlink href=#requesting-an-enrollment-certificate title="Permanent link">&para;</a></h3> <p>Use the <code>flightctl</code> CLI to authenticate with the Flight Control service, then run the following command to obtain enrollment credentials with a validity of one year, in the format of an agent configuration file:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=go>flightctl certificate request --signer=enrollment --expiration=365d --output=embedded &gt; config.yaml</span>
</span></code></pre></div> <p>The returned <code>config.yaml</code> contains the URLs of the Flight Control service, its CA bundle, and the enrollment client certificate and key for the agent. It should look similar to this:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nt>enrollment-service</span><span class=p>:</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>  </span><span class=nt>authentication</span><span class=p>:</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=nt>client-certificate-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBD...</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span><span class=nt>client-key-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBF...</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>  </span><span class=nt>service</span><span class=p>:</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">LS0tLS1CRUdJTiBD...</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://agent-api.flightctl.127.0.0.1.nip.io:7443</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>  </span><span class=nt>enrollment-ui-endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://ui.flightctl.127.0.0.1.nip.io:8081</span>
</span></code></pre></div> <h3 id=building-the-os-image-bootc>Building the OS Image (bootc)<a class=headerlink href=#building-the-os-image-bootc title="Permanent link">&para;</a></h3> <p>Create a file named <code>Containerfile</code> with the following content to build an OS image based on CentOS Stream 9 that includes the Flight Control agent and configuration:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=go>FROM quay.io/centos-bootc/centos-bootc:stream9</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=go>RUN dnf -y copr enable @redhat-et/flightctl &amp;&amp; \</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=go>    dnf -y install flightctl-agent &amp;&amp; \</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=go>    systemctl enable flightctl-agent.service</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=gp># </span>Optional:<span class=w> </span>To<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman-compose<span class=w> </span>application<span class=w> </span>support,<span class=w> </span>uncomment<span class=w> </span>below
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=gp># </span>RUN<span class=w> </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>epel-release<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=gp>#     </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>podman-compose<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=gp>#     </span>dnf<span class=w> </span>-y<span class=w> </span>clean<span class=w> </span>all<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=gp>#     </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman.service
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=go>ADD config.yaml /etc/flightctl/</span>
</span></code></pre></div> <blockquote> <p>[!NOTE] If you have used Podman or Docker before to build application containers, you will notice this is a regular <code>Containerfile</code>, with the only difference that the base image referenced in <code>FROM</code> is bootable container (bootc) image. That means it already contains a Linux kernel. This allows you to reuse existing standard container build tools and workflows.</p> <p>[!NOTE] If your device relies on an OS image from a private repository, <a href=https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/using_image_mode_for_rhel_to_build_deploy_and_manage_operating_systems/index#configuring-container-pull-secrets_managing-users-groups-ssh-key-and-secrets-in-image-mode-for-rhel>authentication credentials</a> (pull secrets) must be placed in the appropriate system path <code>/etc/ostree/auth.json</code>. Authentication must exist on the device before it can be consumed.</p> </blockquote> <p>Define the OCI registry, image repository, and image tag you want to use (ensure you have write-permissions to that repository):</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=go>OCI_REGISTRY=quay.io</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=go>OCI_IMAGE_REPO=${OCI_REGISTRY}/your_org/centos-bootc</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=go>OCI_IMAGE_TAG=v1</span>
</span></code></pre></div> <p>Build the OS image for your target platform:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=go>sudo podman build -t ${OCI_IMAGE_REPO}:${OCI_IMAGE_TAG} .</span>
</span></code></pre></div> <h4 id=using-rhel-base-images>Using RHEL base images<a class=headerlink href=#using-rhel-base-images title="Permanent link">&para;</a></h4> <p>When using Flight Control with a RHEL 9 base image, you need to make a few changes to the <code>Containerfile</code>, specifically you need to disable RHEL's default automatic updates and use a different command to enable the EPEL repository in case you need <code>podman-compose</code>:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=go>FROM registry.redhat.io/rhel9/rhel-bootc:9.5</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=go>RUN dnf -y copr enable @redhat-et/flightctl &amp;&amp; \</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=go>    dnf -y install flightctl-agent &amp;&amp; \</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=go>    systemctl enable flightctl-agent.service &amp;&amp; \</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=go>    systemctl mask bootc-fetch-apply-updates.timer</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=gp># </span>Optional:<span class=w> </span>To<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman-compose<span class=w> </span>application<span class=w> </span>support,<span class=w> </span>uncomment<span class=w> </span>below
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=gp># </span>RUN<span class=w> </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=gp>#     </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>podman-compose<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=gp>#     </span>dnf<span class=w> </span>-y<span class=w> </span>clean<span class=w> </span>all<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=gp>#     </span>rm<span class=w> </span>-rf<span class=w> </span>/var/<span class=o>{</span>cache,log<span class=o>}</span><span class=w> </span>/var/lib/<span class=o>{</span>dnf,rhsm<span class=o>}</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=gp>#     </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman.service
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=go>ADD config.yaml /etc/flightctl/</span>
</span></code></pre></div> <p>You also need to log in to the Red Hat registry before building your image:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=go>sudo podman login registry.redhat.io</span>
</span></code></pre></div> <h3 id=signing-and-publishing-the-os-image-bootc>Signing and Publishing the OS Image (bootc)<a class=headerlink href=#signing-and-publishing-the-os-image-bootc title="Permanent link">&para;</a></h3> <p>There are several methods for signing container images. We will focus on signing with <a href=https://www.sigstore.dev/ >Sigstore</a> signatures using a private key. For other options, refer to the <a href=https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html/building_running_and_managing_containers/assembly_signing-container-images_building-running-and-managing-containers>RHEL</a> or <a href=https://github.com/sigstore/cosign>cosign</a> documentations.</p> <p>Generate a Sigstore key pair <code>signingkey.pub</code> and <code>signingkey.private</code>:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=go>skopeo generate-sigstore-key --output-prefix signingkey</span>
</span></code></pre></div> <p>Configure container tools like Podman and Skopeo to upload Sigstore signatures together with your signed image to your OCI registry:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=go>sudo tee &quot;/etc/containers/registries.d/${OCI_REGISTRY}.yaml&quot; &gt; /dev/null &lt;&lt;EOF</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=go>docker:</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=gp>    $</span><span class=o>{</span>OCI_REGISTRY<span class=o>}</span>:
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=go>        use-sigstore-attachments: true</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=go>EOF</span>
</span></code></pre></div> <p>Log in to your OCI registry, then sign and publish the OS image:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=go>sudo podman login ${OCI_REGISTRY}</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=go>sudo podman push --sign-by-sigstore-private-key ./signingkey.private ${OCI_IMAGE_REPO}:${OCI_IMAGE_TAG}</span>
</span></code></pre></div> <h3 id=building-the-os-disk-image>Building the OS Disk Image<a class=headerlink href=#building-the-os-disk-image title="Permanent link">&para;</a></h3> <p>Next, create a directory called "output" and use <code>bootc-image-builder</code> to generate an OS disk image of type <code>iso</code> from your OS image:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=go>mkdir -p output</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=go>sudo podman run --rm -it --privileged --pull=newer \</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=go>    --security-opt label=type:unconfined_t \</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=go>    -v &quot;${PWD}/output&quot;:/output \</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=go>    -v /var/lib/containers/storage:/var/lib/containers/storage \</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=go>    quay.io/centos-bootc/bootc-image-builder:latest \</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=go>    --type iso \</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=gp>    $</span><span class=o>{</span>OCI_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span>
</span></code></pre></div> <p>Once <code>bootc-image-builder</code> completes, you can find the ISO disk image under <code>${PWD}/output/bootiso/install.iso</code>.</p> <p>Refer to <code>bootc-image-builder</code>'s <a href="https://github.com/osbuild/bootc-image-builder?tab=readme-ov-file#-image-types">list of image types</a> for other supported types.</p> <h3 id=optional-signing-and-publishing-the-os-disk-image-to-an-oci-registry>Optional: Signing and Publishing the OS Disk Image to an OCI Registry<a class=headerlink href=#optional-signing-and-publishing-the-os-disk-image-to-an-oci-registry title="Permanent link">&para;</a></h3> <p>Optionally, you can compress, sign, and publish your disk image as so-called "OCI artifacts" to your OCI registry, too. This helps unify hosting and distribution. For example, to publish your ISO disk image to a repository named after your bootc image with <code>/diskimage-iso</code> appended, run the following commands:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=go>sudo chown -R $(whoami):$(whoami) &quot;${PWD}/output&quot;</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=go>OCI_DISK_IMAGE_REPO=${OCI_IMAGE_REPO}/diskimage-iso</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=go>sudo podman manifest create \</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=gp>    $</span><span class=o>{</span>OCI_DISK_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=go>sudo podman manifest add \</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=go>    --artifact --artifact-type application/vnd.diskimage.iso \</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=go>    --arch=amd64 --os=linux \</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=gp>    $</span><span class=o>{</span>OCI_DISK_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>    </span><span class=s2>&quot;</span><span class=si>${</span><span class=nv>PWD</span><span class=si>}</span><span class=s2>/output/bootiso/install.iso&quot;</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=go>sudo podman manifest push --all \</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=go>     --sign-by-sigstore-private-key ./signingkey.private \</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=gp>    $</span><span class=o>{</span>OCI_DISK_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span>docker://<span class=si>${</span><span class=nv>OCI_DISK_IMAGE_REPO</span><span class=si>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span>
</span></code></pre></div> <h3 id=further-references>Further References<a class=headerlink href=#further-references title="Permanent link">&para;</a></h3> <p>For further information and practical examples, refer to:</p> <ul> <li>Example images in the <a href=https://github.com/flightctl/flightctl-demos>Flight Control demos repository</a>.</li> <li>Flight Control demos repository's <a href=https://github.com/flightctl/flightctl-demos/blob/main/.github/workflows/build-bootc.yaml>automated build pipeline</a>.</li> <li>The Fedora/CentOS bootc project's <a href=https://gitlab.com/fedora/bootc/examples>community-provided examples</a>.</li> </ul> <h2 id=considerations-for-specific-target-platforms>Considerations for Specific Target Platforms<a class=headerlink href=#considerations-for-specific-target-platforms title="Permanent link">&para;</a></h2> <h3 id=red-hat-openshift-virtualization>Red Hat OpenShift Virtualization<a class=headerlink href=#red-hat-openshift-virtualization title="Permanent link">&para;</a></h3> <p>When building an OS image and disk image for OpenShift Virtualization, follow the <a href=#building-and-publishing-os-images-and-disk-images>generic process</a> with the following changes:</p> <ol> <li>Use late binding of the enrollment endpoint and enrollment certificates, injecting the enrollment certificate or even the whole agent configuration through <code>cloud-init</code> when provisioning the virtual device.</li> <li>Add the <code>open-vm-tools</code> guest tools to the image.</li> <li>Build a disk image of type "qcow2" instead of type "iso".</li> <li>Optional: Upload the disk image to an OCI registry as a container disk.</li> </ol> <p>Create a file named <code>Containerfile</code> with the following content to build an OS image based on CentOS Stream 9 that includes the Flight Control agent and VM guest tools, but no agent configuration:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=go>FROM quay.io/centos-bootc/centos-bootc:stream9</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=go>RUN dnf -y copr enable @redhat-et/flightctl &amp;&amp; \</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=go>    dnf -y install flightctl-agent &amp;&amp; \</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=go>    systemctl enable flightctl-agent.service</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=go>RUN dnf -y install cloud-init open-vm-tools &amp;&amp; \</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=go>    ln -s ../cloud-init.target /usr/lib/systemd/system/default.target.wants &amp;&amp; \</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=go>    systemctl enable vmtoolsd.service</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=gp># </span>Optional:<span class=w> </span>To<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman-compose<span class=w> </span>application<span class=w> </span>support,<span class=w> </span>uncomment<span class=w> </span>below
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=gp># </span>RUN<span class=w> </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>epel-release<span class=w> </span>epel-next-release<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=gp>#    </span>dnf<span class=w> </span>-y<span class=w> </span>install<span class=w> </span>podman-compose<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=gp>#    </span>dnf<span class=w> </span>-y<span class=w> </span>clean<span class=w> </span>all<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a><span class=gp>#    </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>podman.service
</span></code></pre></div> <p>Build, sign, and publish the OS image (bootc) following the <a href=#building-and-publishing-os-images-and-disk-images>generic process</a>.</p> <p>For the disk image, build an image of type "qcow2" instead of "iso":</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=go>mkdir -p output</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=go>sudo podman run --rm -it --privileged --pull=newer \</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=go>    --security-opt label=type:unconfined_t \</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=go>    -v &quot;${PWD}/output&quot;:/output \</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=go>    -v /var/lib/containers/storage:/var/lib/containers/storage \</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=go>    quay.io/centos-bootc/bootc-image-builder:latest \</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=go>    --type qcow2 \</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=gp>    $</span><span class=o>{</span>OCI_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span>
</span></code></pre></div> <p>Once <code>bootc-image-builder</code> completes, you can find the disk image under <code>${PWD}/output/qcow2/disk.qcow2</code>.</p> <p>As OpenShift Virtualization can download disk images from an OCI registry, but expects a "container disk" image instead of an OCI artifact, use the following procedure to build, sign, and upload the QCoW2 disk image:</p> <p>Create a file called <code>Containerfile.qcow2</code> with the following content:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=go>FROM registry.access.redhat.com/ubi9/ubi:latest AS builder</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=go>ADD --chown=107:107 output/qcow2/disk.qcow2 /disk/</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=go>RUN chmod 0440 /disk/*</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=go>FROM scratch</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=go>COPY --from=builder /disk/* /disk/</span>
</span></code></pre></div> <p>This adds the QCoW2 disk image to a builder container in order to set the required file ownership (107 is the QEMU user) and file permissions (0440), then copies the file to a scratch image.</p> <p>Next, build, sign, and publish your disk image:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=go>sudo chown -R $(whoami):$(whoami) &quot;${PWD}/output&quot;</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=go>OCI_DISK_IMAGE_REPO=${OCI_IMAGE_REPO}/diskimage-qcow2</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=go>sudo podman build -t ${OCI_DISK_IMAGE_REPO}:${OCI_IMAGE_TAG} -f Containerfile.qcow2 .</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=go>sudo podman push --sign-by-sigstore-private-key ./signingkey.private ${OCI_DISK_IMAGE_REPO}:${OCI_IMAGE_TAG}</span>
</span></code></pre></div> <h3 id=vmware-vsphere>VMware vSphere<a class=headerlink href=#vmware-vsphere title="Permanent link">&para;</a></h3> <p>When building OS images and disk images for VMware vSphere, follow the <a href=#building-and-publishing-os-images-and-disk-images>generic process</a> with the following changes:</p> <ol> <li>Use late binding of the enrollment endpoint and enrollment certificates, injecting the enrollment certificate or even the whole agent configuration through <code>cloud-init</code> when provisioning the virtual device.</li> <li>Add the <code>open-vm-tools</code> guest tools to the image.</li> <li>Build a disk image of type "vmdk" instead of type "iso".</li> </ol> <p>Create a file named <code>Containerfile</code> with the following content to build an OS image based on CentOS Stream 9 that includes the Flight Control agent and VM guest tools, but no agent configuration:</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=go>FROM quay.io/centos-bootc/centos-bootc:stream9</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=go>RUN dnf -y copr enable @redhat-et/flightctl &amp;&amp; \</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=go>    dnf -y install flightctl-agent &amp;&amp; \</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=go>    systemctl enable flightctl-agent.service</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=go>RUN dnf -y install cloud-init open-vm-tools &amp;&amp; \</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=go>    dnf -y clean all &amp;&amp; \</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=go>    ln -s ../cloud-init.target /usr/lib/systemd/system/default.target.wants &amp;&amp; \</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=go>    systemctl enable vmtoolsd.service</span>
</span></code></pre></div> <p>Build the OS image (bootc) in the <a href=#building-and-publishing-os-images-and-disk-images>generic process</a>, but build an image of type "vmdk" instead of "iso":</p> <div class="language-console highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=go>mkdir -p output</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=go>sudo podman run --rm -it --privileged --pull=newer \</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=go>    --security-opt label=type:unconfined_t \</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=go>    -v &quot;${PWD}/output&quot;:/output \</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=go>    -v /var/lib/containers/storage:/var/lib/containers/storage \</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=go>    quay.io/centos-bootc/bootc-image-builder:latest \</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=go>    --type vmdk \</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=gp>    $</span><span class=o>{</span>OCI_IMAGE_REPO<span class=o>}</span>:<span class=si>${</span><span class=nv>OCI_IMAGE_TAG</span><span class=si>}</span>
</span></code></pre></div> <p>Once <code>bootc-image-builder</code> completes, you can find the disk image under <code>${PWD}/output/vmdk/disk.vmdk</code>.</p> <h3 id=references>References<a class=headerlink href=#references title="Permanent link">&para;</a></h3> <p>For details and other target platforms, refer to</p> <ul> <li>The "<a href=https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/9/html-single/using_image_mode_for_rhel_to_build_deploy_and_manage_operating_systems/index#deploying-the-rhel-bootc-images_using-image-mode-for-rhel-to-build-deploy-and-manage-operating-systems>Deploying the RHEL bootc images</a>" section of the RHEL documentation</li> </ul> <h2 id=best-practices-when-building-images>Best Practices When Building Images<a class=headerlink href=#best-practices-when-building-images title="Permanent link">&para;</a></h2> <h3 id=prefer-build-time-configuration-over-dynamic-runtime-configuration>Prefer Build-time Configuration over Dynamic Runtime Configuration<a class=headerlink href=#prefer-build-time-configuration-over-dynamic-runtime-configuration title="Permanent link">&para;</a></h3> <p>Prefer adding configuration to the OS image itself at build-time, so they get tested, distributed, and updated together ("lifecycle-bound"). There are cases when this is not feasible or desirable, in which case use Flight Control's approach to dynamically configure devices at runtime instead:</p> <ul> <li>configuration that is deployment- or site-specific (e.g. a hostname or a site-specific network credential)</li> <li>secrets that are not secure to distribute via the image</li> <li>application workloads that need to be added, updated, or deleted without reboot or on a faster cadence than the OS</li> </ul> <h3 id=prefer-configuration-in-usr-over-etc>Prefer Configuration in /usr over /etc<a class=headerlink href=#prefer-configuration-in-usr-over-etc title="Permanent link">&para;</a></h3> <p>Prefer placing configuration files under <code>/usr</code> if the configuration is static and the application or service supports it. This way, configuration remains read-only and fully defined by the image (avoiding ostree's 3-way merge of <code>/etc</code> as a potential source of drift). There are cases when this is not feasible or desirable:</p> <ul> <li>the configuration is deployment- or site-specific</li> <li>the application or service only supports reading configuration from <code>/etc</code></li> <li>the configuration may need to be changed at runtime (although most applications allow configuration in <code>/etc</code> to override that in <code>/usr</code>)</li> </ul> <h3 id=use-drop-in-directories>Use Drop-in Directories<a class=headerlink href=#use-drop-in-directories title="Permanent link">&para;</a></h3> <p>Avoid editing configuration files, as this is a source of drift and hard to use with declarative configuration management. Instead, most system services support "drop-in directories" (recognized by the <code>.d/</code> at the end of the name) where you can "drop-in" (or replace or remove) configuration files that the service aggregates together. Examples: <code>/etc/containers/certs.d</code>, <code>/etc/cron.d</code>, <code>/etc/NetworkManager/conf.d</code>.</p> <h3 id=avoid-mutating-the-file-system-out-of-band>Avoid Mutating the File System Out-of-Band<a class=headerlink href=#avoid-mutating-the-file-system-out-of-band title="Permanent link">&para;</a></h3> <p>Avoid executing scripts or commands that change the file system as a side-effect, as these may be overwritten by bootc or Flight Control or may lead to drift or failed integrity checks. Instead, run such scripts or commands during image-building, so changes become part of the image or use Flight Control's configuration management mechanisms instead.</p> <h3 id=further-references_1>Further References<a class=headerlink href=#further-references_1 title="Permanent link">&para;</a></h3> <p>See also the guidance in the <a href=https://containers.github.io/bootc/building/guidance.html>bootc documentation</a>.</p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../provisioning-devices/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Provisioning Devices"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Provisioning Devices </div> </div> </a> <a href=../configuring-agent/ class="md-footer__link md-footer__link--next" aria-label="Next: Configuring Agent"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> Configuring Agent </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://github.com/flightctl/flightctl target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.56ea9cef.min.js></script> </body> </html>