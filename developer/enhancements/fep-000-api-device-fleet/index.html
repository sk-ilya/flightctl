<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation for FlightCtl - Fleet management for edge devices"><link href=https://flightctl.github.io/flightctl/developer/enhancements/fep-000-api-device-fleet/ rel=canonical><link href=../ rel=prev><link href=../fep-002-remote-console/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.15"><title>FEP-000 API Device Fleet - FlightCtl Documentation</title><link rel=stylesheet href=../../../assets/stylesheets/main.342714a4.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#ep-definition-of-the-fleet-and-device-api-spec class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="FlightCtl Documentation" class="md-header__button md-logo" aria-label="FlightCtl Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> FlightCtl Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> FEP-000 API Device Fleet </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/flightctl/flightctl title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> flightctl/flightctl </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../user/ class=md-tabs__link> User Guide </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../ class=md-tabs__link> Developer Guide </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="FlightCtl Documentation" class="md-nav__button md-logo" aria-label="FlightCtl Documentation" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> FlightCtl Documentation </label> <div class=md-nav__source> <a href=https://github.com/flightctl/flightctl title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> flightctl/flightctl </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../user/ class=md-nav__link> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href=../../ class="md-nav__link "> <span class=md-ellipsis> Developer Guide </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Developer Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../devicesimulator/ class=md-nav__link> <span class=md-ellipsis> Device Simulator </span> </a> </li> <li class=md-nav__item> <a href=../../metrics/ class=md-nav__link> <span class=md-ellipsis> Metrics </span> </a> </li> <li class=md-nav__item> <a href=../../service-quadlets/ class=md-nav__link> <span class=md-ellipsis> Service Quadlets </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_5> <div class="md-nav__link md-nav__container"> <a href=../../architecture/ class="md-nav__link "> <span class=md-ellipsis> Architecture </span> </a> <label class="md-nav__link " for=__nav_3_5 id=__nav_3_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_5_label aria-expanded=false> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../architecture/architecture/ class=md-nav__link> <span class=md-ellipsis> System Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/tasks/ class=md-nav__link> <span class=md-ellipsis> Tasks </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/field-selectors/ class=md-nav__link> <span class=md-ellipsis> Field Selectors </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/alerts/ class=md-nav__link> <span class=md-ellipsis> Alerts </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/rollout-device-selection/ class=md-nav__link> <span class=md-ellipsis> Rollout Device Selection </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/rollout-disruption-budget/ class=md-nav__link> <span class=md-ellipsis> Rollout Disruption Budget </span> </a> </li> <li class=md-nav__item> <a href=../../architecture/service-observability/ class=md-nav__link> <span class=md-ellipsis> Service Observability </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_6 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> Enhancements </span> </a> <label class="md-nav__link " for=__nav_3_6 id=__nav_3_6_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_6_label aria-expanded=true> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Enhancements </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> FEP-000 API Device Fleet </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> FEP-000 API Device Fleet </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#motivation class=md-nav__link> <span class=md-ellipsis> Motivation </span> </a> <nav class=md-nav aria-label=Motivation> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goals class=md-nav__link> <span class=md-ellipsis> Goals </span> </a> </li> <li class=md-nav__item> <a href=#non-goals class=md-nav__link> <span class=md-ellipsis> Non-Goals </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#proposal class=md-nav__link> <span class=md-ellipsis> Proposal </span> </a> <nav class=md-nav aria-label=Proposal> <ul class=md-nav__list> <li class=md-nav__item> <a href=#general class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=#device-api class=md-nav__link> <span class=md-ellipsis> Device API </span> </a> <nav class=md-nav aria-label="Device API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#device-state-regarding-fleet-managment class=md-nav__link> <span class=md-ellipsis> Device state regarding fleet managment </span> </a> </li> <li class=md-nav__item> <a href=#devicesname-with-no-owner-fleet-individual-device class=md-nav__link> <span class=md-ellipsis> /devices/{name} with no owner fleet (Individual Device) </span> </a> <nav class=md-nav aria-label="/devices/{name} with no owner fleet (Individual Device)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#expected-behavior-regarding-external-references-with-floating-tags class=md-nav__link> <span class=md-ellipsis> Expected behavior regarding external references with floating tags </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#devicesname-while-managed-by-a-fleet-fleet-device class=md-nav__link> <span class=md-ellipsis> /devices/{name} while managed by a fleet (Fleet Device) </span> </a> </li> <li class=md-nav__item> <a href=#devicesnamerendered-device-and-user-read-only class=md-nav__link> <span class=md-ellipsis> /devices/{name}/rendered (device and user read-only) </span> </a> </li> <li class=md-nav__item> <a href=#devicesnamestatus-device-side class=md-nav__link> <span class=md-ellipsis> /devices/{name}/status (device side) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#fleet-api class=md-nav__link> <span class=md-ellipsis> Fleet API </span> </a> <nav class=md-nav aria-label="Fleet API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fleetsname-user-facing class=md-nav__link> <span class=md-ellipsis> /fleets/{name} (user facing) </span> </a> </li> <li class=md-nav__item> <a href=#expected-behavior class=md-nav__link> <span class=md-ellipsis> Expected behavior </span> </a> </li> <li class=md-nav__item> <a href=#device-management-within-a-fleet class=md-nav__link> <span class=md-ellipsis> Device management within a fleet </span> </a> <nav class=md-nav aria-label="Device management within a fleet"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#removing-a-device-from-a-fleet class=md-nav__link> <span class=md-ellipsis> Removing a device from a fleet </span> </a> </li> <li class=md-nav__item> <a href=#changing-a-device-to-a-different-fleet class=md-nav__link> <span class=md-ellipsis> Changing a device to a different fleet </span> </a> </li> <li class=md-nav__item> <a href=#temporarily-disabling-fleet-management-fleet-device-paused class=md-nav__link> <span class=md-ellipsis> Temporarily disabling fleet management (Fleet Device paused) </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#resource-versioning-and-propagation class=md-nav__link> <span class=md-ellipsis> Resource versioning and propagation </span> </a> <nav class=md-nav aria-label="Resource versioning and propagation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#examples-of-resource-propagation class=md-nav__link> <span class=md-ellipsis> Examples of resource propagation </span> </a> <nav class=md-nav aria-label="Examples of resource propagation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fleet-template-changes class=md-nav__link> <span class=md-ellipsis> Fleet template changes </span> </a> </li> <li class=md-nav__item> <a href=#external-fleet-references-changes class=md-nav__link> <span class=md-ellipsis> External fleet references changes </span> </a> </li> <li class=md-nav__item> <a href=#external-device-reference-changes class=md-nav__link> <span class=md-ellipsis> External device reference changes </span> </a> </li> <li class=md-nav__item> <a href=#device-spec-changes class=md-nav__link> <span class=md-ellipsis> Device spec changes </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#user-stories class=md-nav__link> <span class=md-ellipsis> User Stories </span> </a> <nav class=md-nav aria-label="User Stories"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#story-1 class=md-nav__link> <span class=md-ellipsis> Story 1 </span> </a> </li> <li class=md-nav__item> <a href=#story-2 class=md-nav__link> <span class=md-ellipsis> Story 2 </span> </a> </li> <li class=md-nav__item> <a href=#story-3 class=md-nav__link> <span class=md-ellipsis> Story 3 </span> </a> </li> <li class=md-nav__item> <a href=#story-4 class=md-nav__link> <span class=md-ellipsis> Story 4 </span> </a> </li> <li class=md-nav__item> <a href=#story-5 class=md-nav__link> <span class=md-ellipsis> Story 5 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#notesconstraintscaveats class=md-nav__link> <span class=md-ellipsis> Notes/Constraints/Caveats </span> </a> </li> <li class=md-nav__item> <a href=#risks-and-mitigations class=md-nav__link> <span class=md-ellipsis> Risks and Mitigations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-details class=md-nav__link> <span class=md-ellipsis> Design Details </span> </a> <nav class=md-nav aria-label="Design Details"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scalability class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#implementation-history class=md-nav__link> <span class=md-ellipsis> Implementation History </span> </a> </li> <li class=md-nav__item> <a href=#drawbacks class=md-nav__link> <span class=md-ellipsis> Drawbacks </span> </a> </li> <li class=md-nav__item> <a href=#alternatives class=md-nav__link> <span class=md-ellipsis> Alternatives </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../fep-002-remote-console/ class=md-nav__link> <span class=md-ellipsis> FEP-002 Remote Console </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#summary class=md-nav__link> <span class=md-ellipsis> Summary </span> </a> </li> <li class=md-nav__item> <a href=#motivation class=md-nav__link> <span class=md-ellipsis> Motivation </span> </a> <nav class=md-nav aria-label=Motivation> <ul class=md-nav__list> <li class=md-nav__item> <a href=#goals class=md-nav__link> <span class=md-ellipsis> Goals </span> </a> </li> <li class=md-nav__item> <a href=#non-goals class=md-nav__link> <span class=md-ellipsis> Non-Goals </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#proposal class=md-nav__link> <span class=md-ellipsis> Proposal </span> </a> <nav class=md-nav aria-label=Proposal> <ul class=md-nav__list> <li class=md-nav__item> <a href=#general class=md-nav__link> <span class=md-ellipsis> General </span> </a> </li> <li class=md-nav__item> <a href=#device-api class=md-nav__link> <span class=md-ellipsis> Device API </span> </a> <nav class=md-nav aria-label="Device API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#device-state-regarding-fleet-managment class=md-nav__link> <span class=md-ellipsis> Device state regarding fleet managment </span> </a> </li> <li class=md-nav__item> <a href=#devicesname-with-no-owner-fleet-individual-device class=md-nav__link> <span class=md-ellipsis> /devices/{name} with no owner fleet (Individual Device) </span> </a> <nav class=md-nav aria-label="/devices/{name} with no owner fleet (Individual Device)"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#expected-behavior-regarding-external-references-with-floating-tags class=md-nav__link> <span class=md-ellipsis> Expected behavior regarding external references with floating tags </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#devicesname-while-managed-by-a-fleet-fleet-device class=md-nav__link> <span class=md-ellipsis> /devices/{name} while managed by a fleet (Fleet Device) </span> </a> </li> <li class=md-nav__item> <a href=#devicesnamerendered-device-and-user-read-only class=md-nav__link> <span class=md-ellipsis> /devices/{name}/rendered (device and user read-only) </span> </a> </li> <li class=md-nav__item> <a href=#devicesnamestatus-device-side class=md-nav__link> <span class=md-ellipsis> /devices/{name}/status (device side) </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#fleet-api class=md-nav__link> <span class=md-ellipsis> Fleet API </span> </a> <nav class=md-nav aria-label="Fleet API"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fleetsname-user-facing class=md-nav__link> <span class=md-ellipsis> /fleets/{name} (user facing) </span> </a> </li> <li class=md-nav__item> <a href=#expected-behavior class=md-nav__link> <span class=md-ellipsis> Expected behavior </span> </a> </li> <li class=md-nav__item> <a href=#device-management-within-a-fleet class=md-nav__link> <span class=md-ellipsis> Device management within a fleet </span> </a> <nav class=md-nav aria-label="Device management within a fleet"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#removing-a-device-from-a-fleet class=md-nav__link> <span class=md-ellipsis> Removing a device from a fleet </span> </a> </li> <li class=md-nav__item> <a href=#changing-a-device-to-a-different-fleet class=md-nav__link> <span class=md-ellipsis> Changing a device to a different fleet </span> </a> </li> <li class=md-nav__item> <a href=#temporarily-disabling-fleet-management-fleet-device-paused class=md-nav__link> <span class=md-ellipsis> Temporarily disabling fleet management (Fleet Device paused) </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#resource-versioning-and-propagation class=md-nav__link> <span class=md-ellipsis> Resource versioning and propagation </span> </a> <nav class=md-nav aria-label="Resource versioning and propagation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#examples-of-resource-propagation class=md-nav__link> <span class=md-ellipsis> Examples of resource propagation </span> </a> <nav class=md-nav aria-label="Examples of resource propagation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fleet-template-changes class=md-nav__link> <span class=md-ellipsis> Fleet template changes </span> </a> </li> <li class=md-nav__item> <a href=#external-fleet-references-changes class=md-nav__link> <span class=md-ellipsis> External fleet references changes </span> </a> </li> <li class=md-nav__item> <a href=#external-device-reference-changes class=md-nav__link> <span class=md-ellipsis> External device reference changes </span> </a> </li> <li class=md-nav__item> <a href=#device-spec-changes class=md-nav__link> <span class=md-ellipsis> Device spec changes </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#user-stories class=md-nav__link> <span class=md-ellipsis> User Stories </span> </a> <nav class=md-nav aria-label="User Stories"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#story-1 class=md-nav__link> <span class=md-ellipsis> Story 1 </span> </a> </li> <li class=md-nav__item> <a href=#story-2 class=md-nav__link> <span class=md-ellipsis> Story 2 </span> </a> </li> <li class=md-nav__item> <a href=#story-3 class=md-nav__link> <span class=md-ellipsis> Story 3 </span> </a> </li> <li class=md-nav__item> <a href=#story-4 class=md-nav__link> <span class=md-ellipsis> Story 4 </span> </a> </li> <li class=md-nav__item> <a href=#story-5 class=md-nav__link> <span class=md-ellipsis> Story 5 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#notesconstraintscaveats class=md-nav__link> <span class=md-ellipsis> Notes/Constraints/Caveats </span> </a> </li> <li class=md-nav__item> <a href=#risks-and-mitigations class=md-nav__link> <span class=md-ellipsis> Risks and Mitigations </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-details class=md-nav__link> <span class=md-ellipsis> Design Details </span> </a> <nav class=md-nav aria-label="Design Details"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scalability class=md-nav__link> <span class=md-ellipsis> Scalability </span> </a> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> <span class=md-ellipsis> Troubleshooting </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#implementation-history class=md-nav__link> <span class=md-ellipsis> Implementation History </span> </a> </li> <li class=md-nav__item> <a href=#drawbacks class=md-nav__link> <span class=md-ellipsis> Drawbacks </span> </a> </li> <li class=md-nav__item> <a href=#alternatives class=md-nav__link> <span class=md-ellipsis> Alternatives </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/flightctl/flightctl/edit/master/docs/developer/enhancements/fep-000-api-device-fleet.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg> </a> <a href=https://github.com/flightctl/flightctl/raw/master/docs/developer/enhancements/fep-000-api-device-fleet.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg> </a> <h1 id=ep-definition-of-the-fleet-and-device-api-spec>EP: Definition of the Fleet and Device API spec<a class=headerlink href=#ep-definition-of-the-fleet-and-device-api-spec title="Permanent link">&para;</a></h1> <!-- this format is inspired by the K8S KEP format https://raw.githubusercontent.com/kubernetes/enhancements/master/keps/NNNN-kep-template/README.md --> <h2 id=summary>Summary<a class=headerlink href=#summary title="Permanent link">&para;</a></h2> <p>The Device API, and Fleet API, and the dynamics of managing individual devices as well as fleets of devices is a fundamental piece of flightctl.</p> <p>The Fleet API must serve as a way to manage groups of devices while still allowing for the management of individual devices in a way that we can integrate with other management systems.</p> <p>During this RFE two logical controllers are mentioned: <code>device-controller</code> and <code>fleet-controller</code>, those are the logical pieces of our code-base in charge of maintaining the device rendered spec, and the device spec in relation to a fleet. Those controllers are not separate microservices, and this RFE does not mandate or request that.</p> <h2 id=motivation>Motivation<a class=headerlink href=#motivation title="Permanent link">&para;</a></h2> <p>We need agreement on the API design direction and the semantics of the API to be able to implement and grow the flightctl service.</p> <h3 id=goals>Goals<a class=headerlink href=#goals title="Permanent link">&para;</a></h3> <ul> <li> <p>Define the format and behavior of the Device and Fleet APIs</p> </li> <li> <p>Allow the management of individual fleetless devices on a smaller scale as an integration mechanism for services like AAP and ACM.</p> </li> <li> <p>Allow the management of fleets of devices on a larger scale, via gitops or API.</p> </li> <li> <p>Change API fields to provide a more consistent experience.</p> </li> <li> <p>Enable temporary/manual drift of fleet-managed devices for debug purposes.</p> </li> </ul> <h3 id=non-goals>Non-Goals<a class=headerlink href=#non-goals title="Permanent link">&para;</a></h3> <h2 id=proposal>Proposal<a class=headerlink href=#proposal title="Permanent link">&para;</a></h2> <h3 id=general>General<a class=headerlink href=#general title="Permanent link">&para;</a></h3> <p>All resources containing ObjectMeta will include a <code>resourceVersion</code> field, this field is an opaque string that is updated on every change to the resource, it can be used for opportunistic concurrency control.</p> <h3 id=device-api>Device API<a class=headerlink href=#device-api title="Permanent link">&para;</a></h3> <p>The device API is divided into multiple methods, some user-facing, and other device-facing, this design facilitates cleaner RBAC control of the endpoint access. The diagram is only intended to illustrate the flow of information between the user/system and the device.</p> <pre class=mermaid><code>block-beta
columns 1
  user(["User"])

  space


  block
    frontEndpoint["/devices/{name}"]
  end

  user --&gt; frontEndpoint
  frontEndpoint --&gt; user

  space
  block
    metadata
    devSpec["spec"]
    devStatus["status"]
  end

  space

  frontEndpoint --&gt; metadata
  frontEndpoint --&gt; devSpec
  frontEndpoint --&gt; devStatus

  block
     renderedEndpoint["/devices/{name}/rendered"]
     statusEndpoint["/devices/{name}/status"]
  end

  space

  statusEndpoint --&gt; devStatus
  statusEndpoint --&gt; devStatus
  devSpec --&gt; renderedEndpoint
  renderedEndpoint --&gt; Device
  Device --&gt; statusEndpoint


  Device(["Device"])

  style frontEndpoint fill:#969,stroke:#333,stroke-width:4px
  style renderedEndpoint fill:#969,stroke:#333,stroke-width:4px
  style statusEndpoint fill:#969,stroke:#333,stroke-width:4px
  ```

#### `/devices/{name}` User facing method

This endpoint can be accessed by the user or external systems to
manage individual devices, also internally from the fleet specifications
for devices.

The proposed changes include:

* Reincorporating device.spec as a visible part through this frontend API.

* The `device.spec.os.image` contains a reference to the image to be used for the device.

* The `device.spec.templateVersion` is removed. An annotation will be used to track the latest template applied to the
  device. (See the fleet API section for more details)

* The `device.spec.{containers, systemd}` fields are moved under `device.spec.monitoring.{containers, systemd}`

* The `device.spec.monitoring.containers` contains a list of container patterns to be watched on the device (as in the fleet spec)

* The `device.spec.monitoring.systemd` contains a list of systemd service patterns to be watched on the device (as in the fleet spec)

* The `device.spec.config` contains a list of zero or more config items.

* The config items could be inline definition of config files (`InlineConfigProviderSpec`)

* Some config items reference external configurations (`KubernetesSecretProviderSpec`, `GitConfigProviderSpec`)

* External references (image or config items) must support floating tags (`latest`, `main`, `v1.0`), although
  **when managed from a fleet, the floating tags will be frozen as hashes** on the device spec by the
  fleet controller.

* Some external items are actually non-versioned like the K8s secrets, so are inherently floating.

* The `device.status.conditions` field can be extended by the `device-controller` to provide
  additional conditions related to management of the device related to the spec rendering (i.e.
  A source referenced on the spec cannot be found, a reference is not accessible, pre-flight checks
  related to an os-image aren't passing, etc..)
  No other fields on the status or agent-related conditions could be written by the `device-controller`.


Complete representation of the proposed device:

```yaml
apiVersion: flightctl.io/v1alpha1
kind: Device
metadata:
  name: fab9839018890a88b898b980f8f809f8e8ac333761977d987a777a777a987ccce
  labels:
    site: factory-a
    deviceType: optical-inspector
    stage: production
  annotations:
    fleet-controller/templateVersion: "optical-inspector-production-fleet-0000001" # the fleet controller uses this annotation to track the latest template applied
  owner: Fleet/optical-inspector-production-fleet
  resourceVersion: "somehash" # provides opportunistic concurrency control
spec:
  os:
    image: quay.io/redhat/rhde:9.2
  config:
    - name: rendered-config
      configType: InlineConfigProviderSpec
      inline:
        ignition:
          version: 3.4.0
        storage:
          files:
            - contents:
                source: &gt;-
                  data:,This%20system%20is%20managed%20by%20flightctl.%0A
              mode: 422
              overwrite: true
              path: "/etc/motd"

    - name: config-from-git
      configType: GitConfigProviderSpec
      repository: my-repo
      ref: v1.0.0
      path: /path/to/config/in/git

    - name: config-from-k8s-secret
      configType: KubernetesSecretProviderSpec
      name: my-secret
      namespace: my-namespace
      mountPath: /path/to/config/in/device

  monitoring:
    containers:
      matchPatterns:
        - *my-container*
        - *another-container*

    systemd:
      matchPatterns:
        - chronyd.service
        - firewalld.service
        - sshd*.service

status:
  conditions: # NOTE: The conditions will probably need a full definition/documentation/possible adjustments
  - lastTransitionTime: "2024-04-30T15:06:20Z"
    message: All is good
    reason: AsExpected
    status: "False"
    type: Progressing
  - lastTransitionTime: "2024-04-30T15:06:19Z"
    message: All is good
    reason: AsExpected
    status: "True"
    type: Available
  containers:
    - id: fa31890ae222449abb00ff90ed801674
      name: my-container
      status: running
      image: quay.io/myorg/myimage:v1.0.0
      engine: podman
  systemdUnits:
    - name: chronyd.service
      loadState: running     #Q: those fields need clatification, not obvious what they mean
      activeState: active
    - name: sshd.service
      loadState: running
      activeState: active
  systemInfo: # The systemInfo field will likely change in future RFEs, i.e. measurements will probably
              # go away or change format (to provide specific quotes for specific PCRs)
    architecture: arm64
    bootID: 87f7e27e-bdc0-42b1-b909-6dc81fe43ea2
    machineID: fa31890ae222449abb00ff90ed801674
    measurements:
      pcr01: "0000000000000000000000000000000000000000000000000000000000000000"
      ...
      pcr16: "0000000000000000000000000000000000000000000000000000000000000000"
    operatingSystem: linux
  updatedAt: "2024-04-30T15:06:19Z"</code></pre> <h5 id=device-state-regarding-fleet-managment>Device state regarding fleet managment<a class=headerlink href=#device-state-regarding-fleet-managment title="Permanent link">&para;</a></h5> <p>This diagram illustrates what the following sections describe in text. <pre class=mermaid><code>stateDiagram-v2
    state "&lt;b&gt;Individual Device&lt;/b&gt;&lt;br/&gt;&lt;b&gt;owner&lt;/b&gt;: nil (API writable)&lt;br/&gt;&lt;b&gt;spec:&lt;/b&gt; user writable // unmanaged" as Individual_Device
    state "&lt;b&gt;Fleet Device&lt;/b&gt;&lt;br/&gt;&lt;b&gt;owner&lt;/b&gt;: Fleet/the-matching-fleet&lt;br/&gt;&lt;b&gt;spec&lt;/b&gt;: fleet-controller writable // managed" as Fleet_Device
    state "&lt;b&gt;Fleet Device (paused/owner released)&lt;/b&gt;&lt;br/&gt;&lt;b&gt;owner&lt;/b&gt;: nil&lt;br/&gt;&lt;b&gt;spec&lt;/b&gt;: user writable // management paused" as Fleet_Paused
    [*] --&gt; Individual_Device
    Individual_Device --&gt; Fleet_Device : matching fleet labels &amp;&amp; owner == nil
    Fleet_Device --&gt; Individual_Device : no matching fleet labels
    Fleet_Device --&gt; Fleet_Paused : flightctl.io/fleet-controller=paused
    Fleet_Paused--&gt; Fleet_Device: ! flightctl.io/fleet-controller=paused
    Fleet_Paused--&gt; Individual_Device: no matching fleet labels</code></pre></p> <h5 id=devicesname-with-no-owner-fleet-individual-device><code>/devices/{name}</code> with no owner fleet (Individual Device)<a class=headerlink href=#devicesname-with-no-owner-fleet-individual-device title="Permanent link">&para;</a></h5> <p>Devices with no matching labels to a fleet are manually managed and start with no <code>metadata.owner</code> reference; the fleet controller will not attempt to reconcile or configure the device in any way.</p> <p>Ownership of a device can be claimed through the API by setting the <code>metadata.owner</code> field to <code>{owner}/{additional data}</code>, i.e. the fleet-controller can claim a device by setting <code>Fleet/fleet-name</code>. </p> <p><code>metadata.owner</code> is a protected field, specific owners can only be set through the API with specific authentication, i.e. we could use a specific attribute of the X.509 TLS certificate to contain the owner identity, or be passed as a header from the API gateway. This means that the fleet-controller is the only one being able to claim a device to Fleet/ or to release a device claimed by a fleet.</p> <p>External controllers dealing with devices can only set the <code>metadata.owner</code> field to the authentication-allowed {owner} namespace.</p> <p>If a fleet matches this device, and the device has empty <code>metadata.owner</code> the fleet controller will claim the device, by setting <code>metadata.owner</code> to <code>Fleet/{fleet-name}</code>.</p> <p>If a fleet stops matching a device or if the fleet controller is paused on a device, <code>metadata.owner</code> is cleared by the fleet controller, and the device becomes manually managed.</p> <p>The <code>os.image</code> and configuration fields in this API support floating tags, and while the fleet manager does freeze the tags to hashes, the user is free to setup the device spec with floating references.</p> <p>Every time the device is updated in any way, the <code>metadata.resourceVersion</code> field is updated.</p> <p>Every time the device spec changes, the device controller will generate a new device rendered configuration, and update the <code>metadata.annotation['renderedVersion']</code> field.</p> <h6 id=expected-behavior-regarding-external-references-with-floating-tags>Expected behavior regarding external references with floating tags<a class=headerlink href=#expected-behavior-regarding-external-references-with-floating-tags title="Permanent link">&para;</a></h6> <p>Changes on external references are monitored and acted on (git branches, device images, secrets), the device controller should re-evaluate the device spec and apply the changes to the rendered version which will be exposed on the <code>/devices/{name}/rendered</code> endpoint.</p> <p>Every time the rendered output changes due to changes on external references, the <code>metadata.annotation['renderedVersion']</code> is updated this detail is exposed via the <code>/devices/{name}/rendered</code> endpoint. <code>renderedVersion</code> is monotonically increasing and can be used to track changes to the device spec, as well as easily understood by a human observer.</p> <p>Several mechanisms can be used to track external references: * Polling * Webhooks</p> <h5 id=devicesname-while-managed-by-a-fleet-fleet-device><code>/devices/{name}</code> while managed by a fleet (Fleet Device)<a class=headerlink href=#devicesname-while-managed-by-a-fleet-fleet-device title="Permanent link">&para;</a></h5> <p>When managing a device through a fleet, flightctl is responsible for maintaining the device spec in sync with the fleet spec; in this case <em>write access is only possible for the modification of labels and other metadata</em> through this API except for the owner fleet.</p> <blockquote> <p>[!NOTE] Devices managed by a fleet have their floating tags resolved to stable hashes at this API level. This is done to ensure that the device is always in sync with the fleet spec.</p> </blockquote> <p>The device will have an owner reference to the managing fleet, i.e.:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=w>  </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Fleet/optical-inspector-production-fleet</span>
</span></code></pre></div> <h4 id=devicesnamerendered-device-and-user-read-only><code>/devices/{name}/rendered</code> (device and user read-only)<a class=headerlink href=#devicesnamerendered-device-and-user-read-only title="Permanent link">&para;</a></h4> <p>This endpoint is used by the device agent to retrieve the rendered device spec, this endpoint is read-only, each device can only access it's own device rendered spec based on the device certificate identification, a user with admin privileges can access any device rendered spec for debug purposes.</p> <p>The agent can pass: <code>knownRenderedVersion</code>, this is compared to the <code>renderedVersion</code> device annotation, if this opaque field has not changed the API will return 204 No Content, if the field has changed, the API will return the rendered spec.</p> <p>Change proposed: * The parameter name <code>knownOwner</code> is removed. * The parameter name <code>knownTemplateVersion</code>is renamed to <code>knownRenderedVersion</code>.</p> <p>Behavior changes: * If a device configuration is not yet available for rendering (e.g. because it is still being fetched from the configuration source), FC will queue the device for rendering and instruct the device to try again later by returning 202 Accepted.</p> <p>The user can find the fully rendered device spec by using the following CLI command: <div class="language-shell highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>flightctl<span class=w> </span>get<span class=w> </span>device/xxxxxxx<span class=w> </span>--rendered
</span></code></pre></div></p> <p>or</p> <div class="language-shell highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>flightctl<span class=w> </span>get<span class=w> </span>device/xxxxxxx<span class=w> </span>--rendered<span class=w> </span>-o<span class=w> </span>json
</span></code></pre></div> <h4 id=devicesnamestatus-device-side><code>/devices/{name}/status</code> (device side)<a class=headerlink href=#devicesnamestatus-device-side title="Permanent link">&para;</a></h4> <p>This endpoint is used by the device agent to report the status of the device, this endpoint is write-only, each device can only access it's own device status based on the device certificate identification.</p> <p>The result of this write will be exposed on the <code>/devices/{name}</code> endpoint as part of the status field, the status conditions reported from the agent are merged on the <code>/devices/{name}</code> endpoint at read in a way that the user can see the status of the device and the controller status conditions in a single view (See the design details section for more information).</p> <p>Reporting to this endpoint also serves as a heartbeat mechanism, the device agent should report the status, if a device agent stops reporting to this endpoint in the expected timelines, the device will be considered offline.</p> <p>Via this endpoint, the device agent reports <code>renderedVersion</code> instead of <code>templateVersion</code> to indicate the currently applied configuration.</p> <h3 id=fleet-api>Fleet API<a class=headerlink href=#fleet-api title="Permanent link">&para;</a></h3> <p>Fleet is an automation layer on top of Device API, the DeviceTemplate is a mechanism to control drift and enforce policy across devices in a fleet.</p> <p>A DeviceTemplate is a template for a device spec, it's a way to define group specific configuration.</p> <p><a href=https://github.com/flightctl/flightctl/pull/248>We are proposing</a> extension mechanisms to this API to allow for more complex configurations where device labels or name would influence the configuration generated to the device.</p> <h4 id=fleetsname-user-facing><code>/fleets/{name}</code> (user facing)<a class=headerlink href=#fleetsname-user-facing title="Permanent link">&para;</a></h4> <p>This endpoint provides read/write access to fleets.</p> <p>Full example of fleet:</p> <div class="language-yaml highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flightctl.io/v1alpha1</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Fleet</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2024-04-30T14:06:17Z&quot;</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>  </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">optical-inspector-production-fleet</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ResourceSync/basic-nginx-r3sourcesync</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>  </span><span class=nt>selector</span><span class=p>:</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=w>      </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">optical-inspector</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>  </span><span class=nt>template</span><span class=p>:</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>      </span><span class=nt>generation</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=nt>spec</span><span class=p>:</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>      </span><span class=nt>config</span><span class=p>:</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>configType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">InlineConfigProviderSpec</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>        </span><span class=nt>inline</span><span class=p>:</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>          </span><span class=nt>ignition</span><span class=p>:</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>            </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">3.4.0</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>          </span><span class=nt>storage</span><span class=p>:</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>            </span><span class=nt>files</span><span class=p>:</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>            </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>contents</span><span class=p>:</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>                </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">data:,This%20system%20is%20managed%20by%20flightctl.%0A</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>              </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">422</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>              </span><span class=nt>overwrite</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>              </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/motd</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">motd-update</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>configType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitConfigProviderSpec</span>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>        </span><span class=nt>gitRef</span><span class=p>:</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/basic-nginx-demo/configuration</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>          </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">basic-nginx-d3mo</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>          </span><span class=nt>targetRevision</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">microshift-manifests</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>configType</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">GitConfigProviderSpec</span>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>        </span><span class=nt>gitRef</span><span class=p>:</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/configuration</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a><span class=w>          </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ricky-super-secrets</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=w>          </span><span class=nt>targetRevision</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">main</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ricky-super-secrets</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=w>      </span><span class=nt>os</span><span class=p>:</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/flightctl/flightctl-agent-basic-nginx:latest</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=w>      </span><span class=nt>monitoring</span><span class=p>:</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=w>        </span><span class=nt>systemd</span><span class=p>:</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=w>          </span><span class=nt>matchPatterns</span><span class=p>:</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">microshift.service</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">crio.service</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a><span class=w>          </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">flightctl-agent.service</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a><span class=nt>status</span><span class=p>:</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s>&quot;2024-05-09T14:20:21Z&quot;</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s>&quot;False&quot;</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">OverlappingSelectors</span>
</span></code></pre></div> <h4 id=expected-behavior>Expected behavior<a class=headerlink href=#expected-behavior title="Permanent link">&para;</a></h4> <blockquote> <p>[!NOTE] This section dives into the implementation details of the fleet controller, the <code>TemplateVersion</code> is an internal object that is used to track changes to fleet spec device templates and source references. It is useful to provide an audit trail of the changes to the fleet templates and sources. It's also useful to enable implementations where offline devices can traverse a history of configurations to reach the current state.</p> </blockquote> <p>When <code>fleet.spec.template</code> is updated the Fleet deployment changes, a copy of the device template is stored as a <code>TemplateVersion</code> object. This object freezes a copy of the template and also creates a list of external references (like git refs, image tags, etc..) that are floating tags by scanning all fleet devices, these floating tags are resolved to stable hashes and stored in (or along) the <code>TemplateVersion</code> object.</p> <p>When a previously frozen source changes, a new copy of <code>TemplateVersion</code> object is created with the updated source reference.</p> <p>If an error happens during the creation of the <code>TemplateVersion</code> object, the fleet controller will mark a status condition on the fleet object (e.g. missing sources, missing floating tags, etc..), and the fleet controller will not proceed with the rollout.</p> <p>Once a <code>TemplateVersion</code> is created the fleet controller starts rolling out that update to devices. This update can take a long time (depending on the upgrade strategy). The fleet controller marks the latest template version that is being rolled out, as a <code>fleet-controller/templateVersion</code> annotation in the fleet for observability through the API.</p> <p>When a template is applied to a specific device via the Device API: * Floating tags for external references (os image, git refs, etc..) get converted to stable tags (hashes), this gives flightctl the ability to check images being deployed on devices before the device could auto pick-up a floating tag. (i.e. checks verifying the installation of the flightctl agent, and configuration) * When later in time a device has labels updated, the device controller will queue the device to be re-evaulated, for example if a change of fleet owner happens because of the label changes. * An <code>annotation</code> is added to the device in the form of <code>fleet-controller/templateVersion</code> to track the latest <code>TemplateVersion</code> applied to the device.</p> <p>TemplateVersions are exposed via the API as read-only objects, they can be used to track changes to the fleet spec and the external references that were frozen on the devices:</p> <ul> <li><code>/fleets/{name}/templateversions</code> - This endpoint enables listing and cleanup of <code>TemplateVersion</code> objects. Allows filtering by labels.</li> <li><code>/fleets/{name}/templateversions/{version}</code> - This endpoint returns a specific <code>TemplateVersion</code> object for the fleet.</li> </ul> <h4 id=device-management-within-a-fleet>Device management within a fleet<a class=headerlink href=#device-management-within-a-fleet title="Permanent link">&para;</a></h4> <h5 id=removing-a-device-from-a-fleet>Removing a device from a fleet<a class=headerlink href=#removing-a-device-from-a-fleet title="Permanent link">&para;</a></h5> <p>A device could be stripped from the labels associating it to a specific fleet, in such case the <code>metadata.owner</code> field will be cleared by the fleet controller, and the device spec will need to be manually managed or eventually associated to a different fleet/owner.</p> <h5 id=changing-a-device-to-a-different-fleet>Changing a device to a different fleet<a class=headerlink href=#changing-a-device-to-a-different-fleet title="Permanent link">&para;</a></h5> <p>A device could be moved to a different fleet, in such case the <code>metadata.owner</code> field will be updated by the fleet controller, and the device will be managed by the new fleet.</p> <p>This can be performed by modifying device labels to match a new fleet or modifying the fleet's device selector.</p> <p>The fleet controller will apply the latest <code>TemplateVersion</code> for the new fleet to the device.</p> <h5 id=temporarily-disabling-fleet-management-fleet-device-paused>Temporarily disabling fleet management (Fleet Device paused)<a class=headerlink href=#temporarily-disabling-fleet-management-fleet-device-paused title="Permanent link">&para;</a></h5> <p>A user can temporarily stop fleet management of a device by setting the <code>fleet-controller=paused</code> in the device labels, the fleet manager will ignore devices with this label for any subsequent update or rollout.</p> <p>This feature is intended to allow temporarily debugging a device. To allow non-fleet writes the fleet controller will clear the <code>metadata.owner</code> field, and the device will be manually managed.</p> <p>We would know that a device belongs to a fleet because of the labels, but the <code>metadata.owner</code> field would be empty.</p> <p>At this point the device will not receive updates from new <code>TemplateVersions</code> generated from a fleet, and the API will allow editing the device spec.</p> <p>When a fleet selected device has the <code>fleet-controller=paused</code> label removed the fleet controller will reclaim ownership of the device by setting the <code>metadata.owner</code> field and then it will roll-out the latest <code>TemplateVersion</code> to the device, or a series of template versions if the policies and fleet controller implement that.</p> <h3 id=resource-versioning-and-propagation>Resource versioning and propagation<a class=headerlink href=#resource-versioning-and-propagation title="Permanent link">&para;</a></h3> <p>Fleets provide an annotation in the form of <code>fleet-controller/templateVersion</code>, this field is used to track the TemplateVersion that is being rolled out to devices.</p> <p>When the fleet controller applies a template to a device, this is tracked transparently through the <code>fleet-controller/templateVersion</code> on the device metadata, in this case this annotation will reference the latest applied <code>TemplateVersion</code> from the owning fleet.</p> <p>In addition devices have a <code>renderedVersion</code> annotation in metadata, this field is used to track changes to the resulting rendered spec seen by the device, this field can change under the following circumstances:</p> <ul> <li>The device spec has been modified by the fleet controller or the user:</li> <li>Due to changes in the fleet template.</li> <li>Due to changes in floating changes referenced by the fleet template, but frozen on the device spec</li> <li>Due to changes of fleet</li> <li> <p>Due to changes in labels (see <a class="magiclink magiclink-github magiclink-issue" href=https://github.com/flightctl/PR/issues/248 title="GitHub Issue: flightctl/PR #248">PR#248</a>)</p> </li> <li> <p>The device render has been re-rendered due to changes in floating tags or external references directly applied on the device spec (e.g. when a device is individually managed).</p> </li> </ul> <h4 id=examples-of-resource-propagation>Examples of resource propagation<a class=headerlink href=#examples-of-resource-propagation title="Permanent link">&para;</a></h4> <h5 id=fleet-template-changes>Fleet template changes<a class=headerlink href=#fleet-template-changes title="Permanent link">&para;</a></h5> <p>1) A fleet.spec.template changes. 2) A new <code>TemplateVersion</code> object is created. 3) The <code>fleet-controller/templateVersion</code> annotation is updated on the fleet. 4) The fleet controller starts rolling out the new template to devices. 5) When a device is applied the new template, the <code>fleet-controller/templateVersion</code> annotation is added to the device. 6) The device controller re-renders the device spec and updates the <code>renderedVersion</code> annotation. 7) The device finds a new rendered spec via the <code>/devices/{name}/rendered</code> endpoint. 8) The device controller reports the new <code>renderedVersion</code> on the <code>/devices/{name}/status</code> endpoint.</p> <h5 id=external-fleet-references-changes>External fleet references changes<a class=headerlink href=#external-fleet-references-changes title="Permanent link">&para;</a></h5> <p>1) A fleet external reference changes (e.g. a git ref, or an image tag). 2) A new <code>TemplateVersion</code> object is created, with the updated reference. 3) The <code>fleet-controller/templateVersion</code> annotation is updated on the fleet. 4) The fleet controller starts rolling out the new template to devices. 5) When a device is applied the new template, the <code>fleet-controller/templateVersion</code> annotation is added to the device. 6) The device controller re-renders the device spec and updates the <code>renderedVersion</code> annotation. 7) The device finds a new rendered spec via the <code>/devices/{name}/rendered</code> endpoint. 8) The device controller reports the new <code>renderedVersion</code> on the <code>/devices/{name}/status</code> endpoint.</p> <h5 id=external-device-reference-changes>External device reference changes<a class=headerlink href=#external-device-reference-changes title="Permanent link">&para;</a></h5> <p>1) A device external reference changes (e.g. a git ref, or an image tag). 2) The device controller re-renders the device spec and updates the <code>renderedVersion</code> annotation. 3) The device finds a new rendered spec via the <code>/devices/{name}/rendered</code> endpoint. 4) The device controller reports the new <code>renderedVersion</code> on the <code>/devices/{name}/status</code> endpoint.</p> <h5 id=device-spec-changes>Device spec changes<a class=headerlink href=#device-spec-changes title="Permanent link">&para;</a></h5> <p>1) A device spec changes. 2) The device controller re-renders the device spec and updates the <code>renderedVersion</code> annotation. 3) The device finds a new rendered spec via the <code>/devices/{name}/rendered</code> endpoint. 4) The device controller reports the new <code>renderedVersion</code> on the <code>/devices/{name}/status</code> endpoint.</p> <h3 id=user-stories>User Stories<a class=headerlink href=#user-stories title="Permanent link">&para;</a></h3> <h4 id=story-1>Story 1<a class=headerlink href=#story-1 title="Permanent link">&para;</a></h4> <p>As an IT user, I want to manage several devices used for different purposes, those devices don't share the similar configuration and image with other devices.</p> <h4 id=story-2>Story 2<a class=headerlink href=#story-2 title="Permanent link">&para;</a></h4> <p>As an IT user, I want to manage a small number of MicroShift devices individually via RHACM, similar to how I manage OpenShift clusters and SNOs.</p> <h4 id=story-3>Story 3<a class=headerlink href=#story-3 title="Permanent link">&para;</a></h4> <p>As an IT user, I want to manage several RHEL devices declaratively via AAP, so I can orchestrate very complex update workflows.</p> <h4 id=story-4>Story 4<a class=headerlink href=#story-4 title="Permanent link">&para;</a></h4> <p>As an IT user, I want to be able to easily get a device’s spec via the CLI, so I can compare it with the device template and verify how external references have been frozen.</p> <h4 id=story-5>Story 5<a class=headerlink href=#story-5 title="Permanent link">&para;</a></h4> <p>As an IT user, I want to pause fleet management on specific devices, so I can perform manual changes on the spec for debugging purposes without the fleet controller rolling back the changes.</p> <h3 id=notesconstraintscaveats>Notes/Constraints/Caveats<a class=headerlink href=#notesconstraintscaveats title="Permanent link">&para;</a></h3> <p>Devices don't keep track of the rendered specs and sources over time. This could be captured so far by emitting event logs. This could be extended in the feature to provide better traceability but it's left out of scope because when devices are managed by a Fleet this is already being captured as TemplateVersions, and capturing it again on devices would be redundant and impact scalability.</p> <h3 id=risks-and-mitigations>Risks and Mitigations<a class=headerlink href=#risks-and-mitigations title="Permanent link">&para;</a></h3> <p>TemplateVersions could accumulate and grow in size, we need to have a mechanism to clean up old versions, or to archive them into an audit trail when those template versions aren't necessary anymore for a device.</p> <h2 id=design-details>Design Details<a class=headerlink href=#design-details title="Permanent link">&para;</a></h2> <p>We have some design details in the proposal, all references to <code>TemplateVersion</code> is a design detail outside of the core Fleet/API spec, but necessary to define expected behavior.</p> <p>The device reporting to the <code>/devices/{name}/status</code> includes conditions that are stored in a separate field in the device database, then those conditions are merged with the status field on the device spec read from the <code>/devices/{name}</code> endpoint. This is useful to provide the agent the ability to clear/remove conditions by just not posting them to the status endpoint during an update.</p> <h3 id=scalability>Scalability<a class=headerlink href=#scalability title="Permanent link">&para;</a></h3> <h3 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">&para;</a></h3> <h2 id=implementation-history>Implementation History<a class=headerlink href=#implementation-history title="Permanent link">&para;</a></h2> <h2 id=drawbacks>Drawbacks<a class=headerlink href=#drawbacks title="Permanent link">&para;</a></h2> <h2 id=alternatives>Alternatives<a class=headerlink href=#alternatives title="Permanent link">&para;</a></h2> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../ class="md-footer__link md-footer__link--prev" aria-label="Previous: Enhancement Proposals"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Enhancement Proposals </div> </div> </a> <a href=../fep-002-remote-console/ class="md-footer__link md-footer__link--next" aria-label="Next: FEP-002 Remote Console"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> FEP-002 Remote Console </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href=https://github.com/flightctl/flightctl target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.56ea9cef.min.js></script> </body> </html>